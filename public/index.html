<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Occupational Safety Analysis – Report Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      --bg: #0f172a;
      --card: #ffffff;
      --border-subtle: #e5e7eb;
      --text-main: #111827;
      --text-muted: #6b7280;
      --accent: #2563eb;
      --accent-dark: #1d4ed8;
      --danger: #dc2626;
    }

    *,
    *::before,
    *::after {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: radial-gradient(circle at top, #1f2937, #020617 55%);
      color: var(--text-main);
    }

    .page {
      min-height: 100vh;
      padding: 2rem 1rem 3rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1.5rem;
    }

    .page-header {
      max-width: 900px;
      text-align: center;
      color: #e5e7eb;
    }

    .page-header h1 {
      font-size: clamp(1.9rem, 3vw, 2.4rem);
      margin-bottom: 0.5rem;
    }

    .page-header p {
      margin: 0;
      font-size: 0.95rem;
      color: #cbd5f5;
    }

    .panel {
      background: var(--card);
      border-radius: 1rem;
      padding: 1.75rem 1.75rem 1.5rem;
      width: 100%;
      max-width: 900px;
      box-shadow: 0 24px 60px rgba(15, 23, 42, 0.55);
    }

    .panel h2 {
      margin-top: 0;
      margin-bottom: 0.8rem;
      font-size: 1.1rem;
    }

    .panel-subtitle {
      margin-top: 0;
      margin-bottom: 1.3rem;
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1rem;
      margin-bottom: 0.75rem;
    }

    .field {
      margin-bottom: 0.9rem;
    }

    .field label {
      display: block;
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 0.35rem;
      color: #4b5563;
    }

    .required {
      color: var(--danger);
      margin-left: 0.15rem;
    }

    .field input,
    .field textarea {
      width: 100%;
      padding: 0.6rem 0.75rem;
      border-radius: 0.55rem;
      border: 1px solid #d1d5db;
      font-size: 0.95rem;
      color: var(--text-main);
      background: #f9fafb;
      resize: vertical;
      min-height: 0;
    }

    .field textarea {
      min-height: 90px;
    }

    .field input::placeholder,
    .field textarea::placeholder {
      color: #9ca3af;
    }

    .field input:focus,
    .field textarea:focus {
      outline: 2px solid rgba(37, 99, 235, 0.3);
      border-color: var(--accent);
      background: #ffffff;
    }

    .field-note {
      font-size: 0.78rem;
      color: var(--text-muted);
      margin-top: 0.25rem;
    }

    .file-status {
      font-size: 0.78rem;
      margin-top: 0.2rem;
      color: var(--text-muted);
    }

    .file-status--ok {
      color: #15803d;
    }

    .file-status--error {
      color: #b91c1c;
    }

    .actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      margin-top: 1.1rem;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.65rem 1.5rem;
      border-radius: 999px;
      border: 1px solid transparent;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      transition: all 0.15s ease;
      user-select: none;
      white-space: nowrap;
    }

    .btn-primary {
      background: var(--accent);
      color: #ffffff;
      box-shadow: 0 12px 30px rgba(37, 99, 235, 0.35);
    }

    .btn-primary:hover {
      background: var(--accent-dark);
      transform: translateY(-1px);
      box-shadow: 0 18px 40px rgba(37, 99, 235, 0.45);
    }

    .btn-outline {
      background: #ffffff;
      color: var(--text-main);
      border-color: #d1d5db;
    }

    .btn-outline:hover {
      background: #f9fafb;
      border-color: #9ca3af;
    }

    .btn:disabled {
      opacity: 0.45;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    .report {
      margin-top: 0.25rem;
    }

    .report-toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
      margin-bottom: 0.8rem;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 0.2rem 0.7rem;
      border-radius: 999px;
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      background: #eef2ff;
      color: #4f46e5;
    }

    #reportPreview h1 {
      margin-top: 0;
      margin-bottom: 0.75rem;
      font-size: 1.4rem;
    }

    #reportPreview h2 {
      margin-top: 1.2rem;
      margin-bottom: 0.3rem;
      font-size: 1.05rem;
    }

    #reportPreview p {
      margin: 0 0 0.35rem;
      font-size: 0.9rem;
      line-height: 1.6;
      color: #374151;
    }

    #reportPreview hr {
      border: 0;
      border-top: 1px solid var(--border-subtle);
      margin: 1rem 0 1.1rem;
    }

    .meta-line {
      font-size: 0.82rem;
      color: var(--text-muted);
      margin-bottom: 0.4rem;
    }

    .hidden {
      display: none;
    }

    @media (max-width: 640px) {
      .page {
        padding-top: 1.5rem;
      }

      .panel {
        padding: 1.25rem 1rem 1.1rem;
        border-radius: 0.9rem;
      }

      .actions {
        flex-direction: column;
        align-items: stretch;
      }

      .btn {
        width: 100%;
        justify-content: center;
      }
    }
  </style>
</head>

<body>
  <main class="page">
    <header class="page-header">
      <h1>Occupational Safety Analysis</h1>
      <p>
        Fill in the details below, optionally upload a safety log file, generate
        your report, then export it as a polished PDF.
      </p>
    </header>

    <!-- INPUT FORM -->
    <section class="panel">
      <h2>Report details</h2>
      <p class="panel-subtitle">
        These fields are used to automatically build the report. Required
        fields are marked with <span class="required">*</span>.
      </p>

      <form id="reportForm" novalidate>
        <div class="grid">
          <div class="field">
            <label for="organizationName">
              Organization / site<span class="required">*</span>
            </label>
            <input
              id="organizationName"
              type="text"
              required
              placeholder="e.g. ACME Manufacturing – Plant 3"
            />
          </div>

          <div class="field">
            <label for="reportPeriod">
              Reporting period<span class="required">*</span>
            </label>
            <input
              id="reportPeriod"
              type="text"
              required
              placeholder="e.g. January–March 2025"
            />
          </div>

          <div class="field">
            <label for="preparedBy">
              Prepared by<span class="required">*</span>
            </label>
            <input
              id="preparedBy"
              type="text"
              required
              placeholder="Your name / role"
            />
          </div>
        </div>

        <!-- NEW: FILE UPLOAD FIELD -->
        <div class="field">
          <label for="dataFile">
            Safety log file (optional, for auto‑analysis)
          </label>
          <input
            id="dataFile"
            type="file"
            accept=".csv,.txt"
          />
          <div class="field-note">
            Recommended: CSV with columns like
            <code>risk, category, location, status, description</code>.
            We’ll analyze this and include key statistics in the report.
          </div>
          <div id="fileStatus" class="file-status">
            No file selected.
          </div>
        </div>

        <div class="field">
          <label for="summary">
            Summary<span class="required">*</span>
          </label>
          <textarea
            id="summary"
            required
            rows="4"
            placeholder="High-level overview of safety performance, key achievements, and general trends…"
          ></textarea>
        </div>

        <div class="field">
          <label for="criticalIncidents">
            Critical incidents overview<span class="required">*</span>
          </label>
          <textarea
            id="criticalIncidents"
            required
            rows="4"
            placeholder="Describe critical incidents, near misses, root causes, and patterns observed…"
          ></textarea>
        </div>

        <div class="field">
          <label for="priorities">
            Next-year safety priorities<span class="required">*</span>
          </label>
          <textarea
            id="priorities"
            required
            rows="4"
            placeholder="List key initiatives, training, process changes, and investment priorities for the next period…"
          ></textarea>
        </div>

        <div class="actions">
          <button
            type="button"
            id="generateBtn"
            class="btn btn-primary"
          >
            Generate report
          </button>

          <button
            type="button"
            id="pdfBtn"
            class="btn btn-outline"
            disabled
          >
            Make PDF
          </button>
        </div>
      </form>
    </section>

    <!-- REPORT PREVIEW -->
    <section
      id="reportContainer"
      class="panel report hidden"
      aria-live="polite"
    >
      <div class="report-toolbar">
        <span class="badge">Preview</span>
        <button
          type="button"
          id="topPdfBtn"
          class="btn btn-outline"
          disabled
        >
          Make PDF
        </button>
      </div>

      <div id="reportPreview"></div>
    </section>
  </main>

  <!-- jsPDF via CDN for PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    (function () {
      const form = document.getElementById("reportForm");
      const generateBtn = document.getElementById("generateBtn");
      const pdfBtn = document.getElementById("pdfBtn");
      const topPdfBtn = document.getElementById("topPdfBtn");
      const reportContainer = document.getElementById("reportContainer");
      const reportPreview = document.getElementById("reportPreview");

      const fileInput = document.getElementById("dataFile");
      const fileStatus = document.getElementById("fileStatus");

      function escapeHtml(str) {
        return str.replace(/[&<>"']/g, function (m) {
          return {
            "&": "&amp;",
            "<": "&lt;",
            ">": "&gt;",
            '"': "&quot;",
            "'": "&#39;",
          }[m];
        });
      }

      function formatTextBlock(text) {
        return escapeHtml(text).replace(/\n/g, "<br>");
      }

      function enablePdfButtons(enabled) {
        [pdfBtn, topPdfBtn].forEach((btn) => {
          if (!btn) return;
          btn.disabled = !enabled;
        });
      }

      function updateFileStatus(message, state) {
        if (!fileStatus) return;
        fileStatus.textContent = message;
        fileStatus.classList.remove("file-status--ok", "file-status--error");
        if (state === "ok") fileStatus.classList.add("file-status--ok");
        if (state === "error") fileStatus.classList.add("file-status--error");
      }

      fileInput.addEventListener("change", () => {
        const file = fileInput.files[0];
        if (!file) {
          updateFileStatus("No file selected.", null);
          return;
        }
        const sizeKb = (file.size / 1024).toFixed(1);
        updateFileStatus(`Selected "${file.name}" (${sizeKb} KB).`, "ok");
      });

      function readFileAsText(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = (e) => resolve(e.target.result || "");
          reader.onerror = () =>
            reject(reader.error || new Error("Could not read file."));
          reader.readAsText(file);
        });
      }

      function analyzeCsv(text) {
        const lines = text
          .split(/\r?\n/)
          .map((l) => l.trim())
          .filter(Boolean);

        if (lines.length < 2) {
          return "<p>Uploaded CSV contains a header but no data rows.</p>";
        }

        const header = lines[0].split(",").map((h) => h.trim().toLowerCase());
        const rows = lines.slice(1);

        const riskIndex = header.indexOf("risk");
        const categoryIndex = header.indexOf("category");

        const riskCounts = { high: 0, medium: 0, low: 0, other: 0 };
        const categoryCounts = {};

        rows.forEach((row) => {
          const cells = row.split(",");
          // Risk
          if (riskIndex >= 0) {
            const risk = (cells[riskIndex] || "").toLowerCase();
            if (risk.includes("high")) riskCounts.high++;
            else if (risk.includes("medium")) riskCounts.medium++;
            else if (risk.includes("low")) riskCounts.low++;
            else riskCounts.other++;
          }
          // Category
          if (categoryIndex >= 0) {
            const cat = (cells[categoryIndex] || "").trim();
            if (cat) {
              categoryCounts[cat] = (categoryCounts[cat] || 0) + 1;
            }
          }
        });

        let html = `<p>The uploaded incident log contains <strong>${rows.length}</strong> records.</p>`;

        if (riskIndex >= 0) {
          html += `<p>Risk distribution (approx.): HIGH: <strong>${riskCounts.high}</strong>, MEDIUM: <strong>${riskCounts.medium}</strong>, LOW: <strong>${riskCounts.low}</strong>${
            riskCounts.other ? `, OTHER: <strong>${riskCounts.other}</strong>` : ""
          }.</p>`;
        }

        const categories = Object.entries(categoryCounts).sort(
          (a, b) => b[1] - a[1]
        );
        if (categories.length) {
          const top = categories.slice(0, 3);
          const formatted = top
            .map(([name, count]) => `${escapeHtml(name)} (${count})`)
            .join(", ");
          html += `<p>Most frequent categories: ${formatted}.</p>`;
        }

        return html;
      }

      function analyzePlainText(text) {
        const lines = text
          .split(/\r?\n/)
          .map((l) => l.trim())
          .filter(Boolean);
        const length = text.length;

        return `
          <p>The uploaded notes file contains <strong>${lines.length}</strong> lines (${length} characters).</p>
          <p>Use these raw notes as supporting evidence for the findings and priorities outlined in this report.</p>
        `;
      }

      async function getFileInsights(file) {
        if (!file) return "";

        updateFileStatus("Reading and analyzing file…", "ok");
        const text = await readFileAsText(file);
        if (!text.trim()) {
          updateFileStatus("The selected file appears to be empty.", "error");
          return "";
        }

        const lower = file.name.toLowerCase();
        let insightsHtml;
        if (lower.endsWith(".csv")) {
          insightsHtml = analyzeCsv(text);
        } else {
          insightsHtml = analyzePlainText(text);
        }

        const sizeKb = (file.size / 1024).toFixed(1);
        updateFileStatus(
          `Analyzed "${file.name}" (${sizeKb} KB). Included summary in the report.`,
          "ok"
        );

        return insightsHtml;
      }

      generateBtn.addEventListener("click", async function (e) {
        e.preventDefault();

        // Validate required fields
        if (!form.reportValidity()) {
          form.reportValidity();
          return;
        }

        const org = document
          .getElementById("organizationName")
          .value.trim();
        const period = document.getElementById("reportPeriod").value.trim();
        const preparedBy = document
          .getElementById("preparedBy")
          .value.trim();
        const summary = document.getElementById("summary").value.trim();
        const incidents = document
          .getElementById("criticalIncidents")
          .value.trim();
        const priorities = document
          .getElementById("priorities")
          .value.trim();

        const today = new Date().toLocaleDateString();

        enablePdfButtons(false);

        // Analyze file if provided
        const file = fileInput.files[0];
        let fileInsightsHtml = "";
        try {
          if (file) {
            fileInsightsHtml = await getFileInsights(file);
          }
        } catch (err) {
          console.error(err);
          updateFileStatus(
            "There was a problem reading the file. Report will be generated without file-based insights.",
            "error"
          );
        }

        const insightsSection = fileInsightsHtml
          ? `
          <h2>Data-driven insights from uploaded file</h2>
          ${fileInsightsHtml}
        `
          : "";

        reportPreview.innerHTML = `
          <h1>Occupational Safety Analysis</h1>
          <p class="meta-line">
            <strong>Organization:</strong> ${escapeHtml(org)}<br />
            <strong>Reporting period:</strong> ${escapeHtml(period)}<br />
            <strong>Prepared by:</strong> ${escapeHtml(
              preparedBy
            )} · <strong>Date:</strong> ${escapeHtml(today)}
          </p>
          <hr />

          <h2>Summary</h2>
          <p>${formatTextBlock(summary)}</p>

          <h2>Critical incidents overview</h2>
          <p>${formatTextBlock(incidents)}</p>

          <h2>Next-year safety priorities</h2>
          <p>${formatTextBlock(priorities)}</p>

          ${insightsSection}
        `;

        reportContainer.classList.remove("hidden");
        enablePdfButtons(true);

        reportContainer.scrollIntoView({ behavior: "smooth" });
      });

      async function makePdf() {
        if (!window.jspdf || !window.jspdf.jsPDF) {
          alert(
            "The PDF library did not load. Please check your network connection."
          );
          return;
        }

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ unit: "mm", format: "a4" });

        // Title
        doc.setFont("helvetica", "bold");
        doc.setFontSize(18);
        doc.text("Occupational Safety Analysis", 15, 20);

        doc.setFont("helvetica", "normal");
        doc.setFontSize(11);

        const lines = reportPreview.innerText
          .split("\n")
          .map((l) => l.trim())
          .filter(Boolean);

        const maxWidth = 180;
        const lineHeight = 6;
        let y = 32;

        lines.forEach((line) => {
          const chunks = doc.splitTextToSize(line, maxWidth);

          chunks.forEach((chunk) => {
            if (y > 280) {
              doc.addPage();
              y = 20;
            }
            doc.text(chunk, 15, y);
            y += lineHeight;
          });

          y += 2; // extra spacing between paragraphs
        });

        const filename =
          "occupational-safety-report-" +
          new Date().toISOString().slice(0, 10) +
          ".pdf";
        doc.save(filename);
      }

      [pdfBtn, topPdfBtn].forEach((btn) => {
        if (!btn) return;
        btn.addEventListener("click", function (e) {
          e.preventDefault();
          makePdf();
        });
      });

      // Start with PDF buttons disabled
      enablePdfButtons(false);
    })();
  </script>
</body>
</html>
