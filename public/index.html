function buildPrompt(kp, filters, summary) {
  const { fromDate, toDate, includedStatuses } = filters;
  const rangeLabel =
    fromDate && toDate
      ? `${fromDate} – ${toDate}`
      : summary.dateRange.from && summary.dateRange.to
      ? `${summary.dateRange.from} – ${summary.dateRange.to}`
      : "full available period";

  const statusLabel = includedStatuses.length
    ? includedStatuses.join(", ")
    : "all statuses";

  return `
You are an occupational safety specialist.

Using ONLY the JSON data below, write a concise report that follows THIS TEXT STRUCTURE
(plain text only, no markdown):

OCCUPATIONAL SAFETY ANALYSIS
KP ${kp} – Reporting period ${rangeLabel}

SUMMARY
- Total observations: <number>
- Period: <start date> – <end date>
- High‑risk cases: <number and % of total>  (use your best judgement for which cases are high risk based on the description and category)
- Positive observations: <number and % if identifiable>
- 2–4 sentences summarising the overall safety situation and key themes.

ALL CASES WITH DATES
Write a 4‑column text table for the most relevant cases. Use this layout in plain text:

Date       | Category                 | Location               | Issue
---------- | ------------------------ | ---------------------- | ----------------------------------------

Then one line per observation (up to about 30 rows), for example:
2025-07-30 | Paloturvallisuusriski    | Omena Hotel Hanko      | Short one‑sentence description of the issue

Use the "sampleObservations" list from the JSON and pick the most representative and serious cases.

KEY ISSUES
Heading: "Key issues:"
Under it, write a numbered list (1., 2., 3., …) of 3–6 key themes.
Each point should group similar incidents (e.g. fire/electrical, sharp objects, falls, threatening situations, etc.)
and reference dates or locations when helpful.

CRITICAL INCIDENTS SUMMARY
Heading: "Critical incidents summary (most severe cases)"
Then a short bullet list of the most severe events (threats, fire, electrical, serious injuries, weapons, etc.)
with dates and 1–2 line descriptions.

RECOMMENDATIONS
Heading: "Recommendations for next period"
Then 3–6 concrete, actionable recommendations based on the issues above.

RULES
- All numbers and categories must match or be consistent with the JSON data.
- Do NOT invent data.
- Keep headings in ALL CAPS exactly as shown.
- Keep the total report length similar to a 1–2 page PDF.

JSON data:
${JSON.stringify(summary, null, 2)}
  `.trim();
}
