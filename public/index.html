<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Occupational Safety Observation – Report Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      --bg: #0f172a;
      --card: #ffffff;
      --border-subtle: #e5e7eb;
      --text-main: #111827;
      --text-muted: #6b7280;
      --accent: #2563eb;
      --accent-dark: #1d4ed8;
      --danger: #dc2626;
    }

    *,
    *::before,
    *::after {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: radial-gradient(circle at top, #1f2937, #020617 55%);
      color: var(--text-main);
    }

    .page {
      min-height: 100vh;
      padding: 2rem 1rem 3rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1.5rem;
    }

    .page-header {
      max-width: 900px;
      text-align: center;
      color: #e5e7eb;
    }

    .page-header h1 {
      font-size: clamp(1.9rem, 3vw, 2.4rem);
      margin-bottom: 0.5rem;
    }

    .page-header p {
      margin: 0;
      font-size: 0.95rem;
      color: #cbd5f5;
    }

    .panel {
      background: var(--card);
      border-radius: 1rem;
      padding: 1.75rem 1.75rem 1.5rem;
      width: 100%;
      max-width: 900px;
      box-shadow: 0 24px 60px rgba(15, 23, 42, 0.55);
    }

    .panel h2 {
      margin-top: 0;
      margin-bottom: 0.8rem;
      font-size: 1.1rem;
    }

    .panel-subtitle {
      margin-top: 0;
      margin-bottom: 1.3rem;
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1rem;
      margin-bottom: 0.75rem;
    }

    .field {
      margin-bottom: 0.9rem;
    }

    .field label {
      display: block;
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 0.35rem;
      color: #4b5563;
    }

    .required {
      color: var(--danger);
      margin-left: 0.15rem;
    }

    .field input,
    .field textarea,
    .field select {
      width: 100%;
      padding: 0.6rem 0.75rem;
      border-radius: 0.55rem;
      border: 1px solid #d1d5db;
      font-size: 0.95rem;
      color: var(--text-main);
      background: #f9fafb;
      resize: vertical;
      min-height: 0;
    }

    .field textarea {
      min-height: 90px;
    }

    .field input::placeholder,
    .field textarea::placeholder {
      color: #9ca3af;
    }

    .field input:focus,
    .field textarea:focus,
    .field select:focus {
      outline: 2px solid rgba(37, 99, 235, 0.3);
      border-color: var(--accent);
      background: #ffffff;
    }

    .field-note {
      font-size: 0.78rem;
      color: var(--text-muted);
      margin-top: 0.25rem;
    }

    .file-status {
      font-size: 0.78rem;
      margin-top: 0.2rem;
      color: var(--text-muted);
    }

    .file-status--ok {
      color: #15803d;
    }

    .file-status--error {
      color: #b91c1c;
    }

    .actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      margin-top: 1.1rem;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.65rem 1.5rem;
      border-radius: 999px;
      border: 1px solid transparent;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      transition: all 0.15s ease;
      user-select: none;
      white-space: nowrap;
    }

    .btn-primary {
      background: var(--accent);
      color: #ffffff;
      box-shadow: 0 12px 30px rgba(37, 99, 235, 0.35);
    }

    .btn-primary:hover {
      background: var(--accent-dark);
      transform: translateY(-1px);
      box-shadow: 0 18px 40px rgba(37, 99, 235, 0.45);
    }

    .btn-outline {
      background: #ffffff;
      color: var(--text-main);
      border-color: #d1d5db;
    }

    .btn-outline:hover {
      background: #f9fafb;
      border-color: #9ca3af;
    }

    .btn:disabled {
      opacity: 0.45;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    .report {
      margin-top: 0.25rem;
    }

    .report-toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
      margin-bottom: 0.8rem;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 0.2rem 0.7rem;
      border-radius: 999px;
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      background: #eef2ff;
      color: #4f46e5;
    }

    #reportPreview h1 {
      margin-top: 0;
      margin-bottom: 0.75rem;
      font-size: 1.4rem;
    }

    #reportPreview h2 {
      margin-top: 1.2rem;
      margin-bottom: 0.3rem;
      font-size: 1.05rem;
    }

    #reportPreview p {
      margin: 0 0 0.35rem;
      font-size: 0.9rem;
      line-height: 1.6;
      color: #374151;
    }

    #reportPreview hr {
      border: 0;
      border-top: 1px solid var(--border-subtle);
      margin: 1rem 0 1.1rem;
    }

    .meta-line {
      font-size: 0.82rem;
      color: var(--text-muted);
      margin-bottom: 0.4rem;
    }

    .hidden {
      display: none;
    }

    @media (max-width: 640px) {
      .page {
        padding-top: 1.5rem;
      }

      .panel {
        padding: 1.25rem 1rem 1.1rem;
        border-radius: 0.9rem;
      }

      .actions {
        flex-direction: column;
        align-items: stretch;
      }

      .btn {
        width: 100%;
        justify-content: center;
      }
    }
  </style>
</head>

<body>
  <main class="page">
    <header class="page-header">
      <h1>Occupational Safety Observation</h1>
      <p>
        Fill in the same fields as your Hailer observation form, optionally
        upload a Hailer export (CSV), generate the report, then export as PDF.
      </p>
    </header>

    <!-- INPUT FORM -->
    <section class="panel">
      <h2>Observation fields (aligned with Hailer)</h2>
      <p class="panel-subtitle">
        Required fields are marked with <span class="required">*</span>.
      </p>

      <form id="reportForm" novalidate>
        <!-- Title + category -->
        <div class="grid">
          <div class="field">
            <label for="title">
              Title<span class="required">*</span>
            </label>
            <input
              id="title"
              type="text"
              required
              placeholder="Short title for the observation"
            />
          </div>

          <div class="field">
            <label for="category">
              Category of the observation<span class="required">*</span>
            </label>
            <select id="category" required>
              <option value="" disabled selected>Choose category</option>
              <option>Asiakkaan omaisuuden rikkoutuminen</option>
              <option>Huoltoasiat</option>
              <option>Kaatuminen</option>
              <option>Kulkureitti tukittu</option>
              <option>Liukastuminen</option>
              <option>Liukkaus</option>
              <option>Muu</option>
              <option>Paloturvallisuusriski / tulipalon uhka</option>
              <option>Positiivinen turvallisuushavainto</option>
              <option>Putoavat esineet / allejäämisen vaara</option>
              <option>Raskaat / painavat kuormien siirrot</option>
              <option>Rikkinäinen imurinjohto</option>
              <option>Rikkinäiset työvälineet</option>
              <option>Rullakko</option>
              <option>Sähköiskun vaara</option>
              <option>Tapaturmariski</option>
              <option>Työergonomia / väärät työasennot</option>
              <option>Uhkaava tilanne</option>
              <option>Valaistuksen puute</option>
              <option>Viiltävät / pistävät esineet</option>
            </select>
            <div class="field-note">
              Matches Hailer’s “Category of the observation”.
            </div>
          </div>
        </div>

        <!-- Site + cost centre -->
        <div class="grid">
          <div class="field">
            <label for="customerSite">
              Customer site<span class="required">*</span>
            </label>
            <input
              id="customerSite"
              type="text"
              required
              placeholder="e.g. Fitness24Seven Oy / Jyväskylä ..."
            />
          </div>

          <div class="field">
            <label for="costCenter">
              Cost center of the site
            </label>
            <input
              id="costCenter"
              type="text"
              placeholder="e.g. KP 88"
            />
          </div>
        </div>

        <!-- People -->
        <div class="grid">
          <div class="field">
            <label for="owner">Owner</label>
            <input
              id="owner"
              type="text"
              placeholder="Owner of the observation"
            />
          </div>

          <div class="field">
            <label for="personInCharge">Person in charge</label>
            <input
              id="personInCharge"
              type="text"
              placeholder="Person in charge of the observation"
            />
          </div>

          <div class="field">
            <label for="employee">Employee</label>
            <input
              id="employee"
              type="text"
              placeholder="Name / ID of the employee"
            />
          </div>

          <div class="field">
            <label for="informant">
              Name of the informant<span class="required">*</span>
            </label>
            <input
              id="informant"
              type="text"
              required
              placeholder="Person who made the observation"
            />
          </div>
        </div>

        <div class="field">
          <label for="othersInvolved">
            Others who may have been involved
          </label>
          <textarea
            id="othersInvolved"
            rows="2"
            placeholder="List other people involved or affected…"
          ></textarea>
        </div>

        <!-- Location + date -->
        <div class="grid">
          <div class="field">
            <label for="location">
              Location (as accurate as possible place, address, site, work number)
              <span class="required">*</span>
            </label>
            <textarea
              id="location"
              required
              rows="2"
              placeholder="e.g. Fitness24Seven Kauppakulma, cleaning storage room…"
            ></textarea>
          </div>

          <div class="field">
            <label for="observationDate">
              Date<span class="required">*</span>
            </label>
            <input
              id="observationDate"
              type="text"
              required
              placeholder="e.g. 11.12.2025 11:00"
            />
            <div class="field-note">
              Free text so you can use the same format as Hailer exports.
            </div>
          </div>
        </div>

        <!-- Description -->
        <div class="field">
          <label for="description">
            Description of the situation (what happened, why, when, who was involved)
            <span class="required">*</span>
          </label>
          <textarea
            id="description"
            required
            rows="4"
            placeholder="Describe what happened, why it happened, when, and who was involved…"
          ></textarea>
        </div>

        <!-- Opinion / prevention -->
        <div class="field">
          <label for="opinion">
            Share your opinion: How could the situation have been avoided or prevented from happening again?
            <span class="required">*</span>
          </label>
          <textarea
            id="opinion"
            required
            rows="4"
            placeholder="Corrective actions, training, guidance, changes to procedures…"
          ></textarea>
        </div>

        <!-- Measures / comments -->
        <div class="field">
          <label for="measures">
            Measures taken as a result of the occupational safety observation
          </label>
          <textarea
            id="measures"
            rows="3"
            placeholder="What actions have already been taken?"
          ></textarea>
        </div>

        <div class="field">
          <label for="comments">
            Comments from the occupational safety organisation
          </label>
          <textarea
            id="comments"
            rows="3"
            placeholder="Internal comments, evaluations, follow-up instructions…"
          ></textarea>
        </div>

        <!-- Reward + file upload -->
        <div class="grid">
          <div class="field">
            <label for="reward">
              Will the observation be rewarded?
            </label>
            <select id="reward">
              <option value="" selected>Not decided / not set</option>
              <option>Yes</option>
              <option>No</option>
            </select>
          </div>

          <div class="field">
            <label for="dataFile">
              Hailer export (CSV, optional)
            </label>
            <input
              id="dataFile"
              type="file"
              accept=".csv"
            />
            <div class="field-note">
              Export observations from Hailer as CSV and upload to include
              simple statistics (count, top categories/sites) in the report.
            </div>
            <div id="fileStatus" class="file-status">
              No file selected.
            </div>
          </div>
        </div>

        <div class="actions">
          <button
            type="button"
            id="generateBtn"
            class="btn btn-primary"
          >
            Generate report
          </button>

          <button
            type="button"
            id="pdfBtn"
            class="btn btn-outline"
            disabled
          >
            Make PDF
          </button>
        </div>
      </form>
    </section>

    <!-- REPORT PREVIEW -->
    <section
      id="reportContainer"
      class="panel report hidden"
      aria-live="polite"
    >
      <div class="report-toolbar">
        <span class="badge">Preview</span>
        <button
          type="button"
          id="topPdfBtn"
          class="btn btn-outline"
          disabled
        >
          Make PDF
        </button>
      </div>

      <div id="reportPreview"></div>
    </section>
  </main>

  <!-- jsPDF via CDN for PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    (function () {
      const form = document.getElementById("reportForm");
      const generateBtn = document.getElementById("generateBtn");
      const pdfBtn = document.getElementById("pdfBtn");
      const topPdfBtn = document.getElementById("topPdfBtn");
      const reportContainer = document.getElementById("reportContainer");
      const reportPreview = document.getElementById("reportPreview");

      const fileInput = document.getElementById("dataFile");
      const fileStatus = document.getElementById("fileStatus");

      function escapeHtml(str) {
        return str.replace(/[&<>"']/g, function (m) {
          return {
            "&": "&amp;",
            "<": "&lt;",
            ">": "&gt;",
            '"': "&quot;",
            "'": "&#39;",
          }[m];
        });
      }

      function formatTextBlock(text) {
        return escapeHtml(text).replace(/\n/g, "<br>");
      }

      function enablePdfButtons(enabled) {
        [pdfBtn, topPdfBtn].forEach((btn) => {
          if (!btn) return;
          btn.disabled = !enabled;
        });
      }

      function updateFileStatus(message, state) {
        if (!fileStatus) return;
        fileStatus.textContent = message;
        fileStatus.classList.remove("file-status--ok", "file-status--error");
        if (state === "ok") fileStatus.classList.add("file-status--ok");
        if (state === "error") fileStatus.classList.add("file-status--error");
      }

      fileInput.addEventListener("change", () => {
        const file = fileInput.files[0];
        if (!file) {
          updateFileStatus("No file selected.", null);
          return;
        }
        const sizeKb = (file.size / 1024).toFixed(1);
        updateFileStatus(`Selected "${file.name}" (${sizeKb} KB).`, "ok");
      });

      function readFileAsText(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = (e) => resolve(e.target.result || "");
          reader.onerror = () =>
            reject(reader.error || new Error("Could not read file."));
          reader.readAsText(file);
        });
      }

      // Simple CSV parser that respects quoted fields
      function parseCsvLine(line) {
        const result = [];
        let current = "";
        let insideQuotes = false;

        for (let i = 0; i < line.length; i++) {
          const ch = line[i];

          if (ch === '"') {
            if (insideQuotes && line[i + 1] === '"') {
              current += '"';
              i++;
            } else {
              insideQuotes = !insideQuotes;
            }
          } else if (ch === "," && !insideQuotes) {
            result.push(current);
            current = "";
          } else {
            current += ch;
          }
        }
        result.push(current);
        return result.map((c) => c.trim());
      }

      function analyzeHailerCsv(text) {
        const lines = text
          .split(/\r?\n/)
          .map((l) => l.trim())
          .filter(Boolean);

        if (lines.length < 2) {
          return "<p>Uploaded CSV contains a header but no data rows.</p>";
        }

        const header = parseCsvLine(lines[0]);
        const rows = lines.slice(1);

        const idxCategory = header.indexOf("Category of the observation");
        const idxSite = header.indexOf("Customer site");
        const idxCost = header.indexOf("Cost center of the site");

        const categoryCounts = {};
        const siteCounts = {};

        rows.forEach((row) => {
          const cells = parseCsvLine(row);
          if (idxCategory >= 0) {
            const cat = (cells[idxCategory] || "").trim();
            if (cat) categoryCounts[cat] = (categoryCounts[cat] || 0) + 1;
          }
          if (idxSite >= 0) {
            const site = (cells[idxSite] || "").trim();
            if (site) siteCounts[site] = (siteCounts[site] || 0) + 1;
          }
        });

        const total = rows.length;
        let html = `<p>The imported Hailer dataset contains <strong>${total}</strong> observations.</p>`;

        const categories = Object.entries(categoryCounts).sort(
          (a, b) => b[1] - a[1]
        );
        if (categories.length) {
          const top = categories.slice(0, 3);
          const formatted = top
            .map(
              ([name, count]) =>
                `${escapeHtml(name)} (${count})`
            )
            .join(", ");
          html += `<p>Most frequent observation categories: ${formatted}.</p>`;
        }

        const sites = Object.entries(siteCounts).sort(
          (a, b) => b[1] - a[1]
        );
        if (sites.length && idxCost >= 0) {
          const topSite = sites[0][0];
          html += `<p>Site with the most observations: ${escapeHtml(
            topSite
          )}.</p>`;
        }

        return html;
      }

      async function getFileInsights(file) {
        if (!file) return "";

        updateFileStatus("Reading and analyzing CSV…", "ok");
        const text = await readFileAsText(file);
        if (!text.trim()) {
          updateFileStatus("The selected file appears to be empty.", "error");
          return "";
        }

        let insightsHtml = analyzeHailerCsv(text);

        const sizeKb = (file.size / 1024).toFixed(1);
        updateFileStatus(
          `Analyzed "${file.name}" (${sizeKb} KB). Included summary in the report.`,
          "ok"
        );

        return insightsHtml;
      }

      generateBtn.addEventListener("click", async function (e) {
        e.preventDefault();

        if (!form.reportValidity()) {
          form.reportValidity();
          return;
        }

        const title = document.getElementById("title").value.trim();
        const category = document.getElementById("category").value.trim();
        const customerSite = document.getElementById("customerSite").value.trim();
        const costCenter = document.getElementById("costCenter").value.trim();
        const owner = document.getElementById("owner").value.trim();
        const personInCharge = document.getElementById("personInCharge").value.trim();
        const employee = document.getElementById("employee").value.trim();
        const informant = document.getElementById("informant").value.trim();
        const othersInvolved = document.getElementById("othersInvolved").value.trim();
        const location = document.getElementById("location").value.trim();
        const observationDate = document.getElementById("observationDate").value.trim();
        const description = document.getElementById("description").value.trim();
        const opinion = document.getElementById("opinion").value.trim();
        const measures = document.getElementById("measures").value.trim();
        const comments = document.getElementById("comments").value.trim();
        const reward = document.getElementById("reward").value.trim();

        enablePdfButtons(false);

        const file = fileInput.files[0];
        let fileInsightsHtml = "";
        try {
          if (file) {
            fileInsightsHtml = await getFileInsights(file);
          }
        } catch (err) {
          console.error(err);
          updateFileStatus(
            "There was a problem reading the file. Report will be generated without file-based statistics.",
            "error"
          );
        }

        let peopleHtml = "";
        if (owner) {
          peopleHtml += `<strong>Owner:</strong> ${escapeHtml(owner)}<br />`;
        }
        if (personInCharge) {
          peopleHtml += `<strong>Person in charge:</strong> ${escapeHtml(
            personInCharge
          )}<br />`;
        }
        if (employee) {
          peopleHtml += `<strong>Employee:</strong> ${escapeHtml(employee)}<br />`;
        }
        if (informant) {
          peopleHtml += `<strong>Informant:</strong> ${escapeHtml(
            informant
          )}<br />`;
        }
        if (othersInvolved) {
          peopleHtml += `<strong>Others involved:</strong> ${formatTextBlock(
            othersInvolved
          )}<br />`;
        }
        if (!peopleHtml) {
          peopleHtml = "No named persons recorded.";
        }

        const today = new Date().toLocaleDateString();

        const locationHtml = location
          ? `<strong>Location:</strong> ${formatTextBlock(location)}<br />`
          : "";

        const costCenterHtml = costCenter
          ? ` · <strong>Cost center:</strong> ${escapeHtml(costCenter)}`
          : "";

        const rewardHtml = reward
          ? `<br /><br /><strong>Reward decision:</strong> ${escapeHtml(
              reward
            )}.`
          : "";

        const commentsHtml = comments
          ? `<br /><br /><strong>Comments from the occupational safety organisation:</strong><br />${formatTextBlock(
              comments
            )}`
          : "";

        const insightsSection = fileInsightsHtml
          ? `
          <h2>Statistics from imported Hailer data</h2>
          ${fileInsightsHtml}
        `
          : "";

        reportPreview.innerHTML = `
          <h1>Occupational Safety Observation</h1>

          <p class="meta-line">
            <strong>Title:</strong> ${escapeHtml(title)}<br />
            <strong>Category:</strong> ${escapeHtml(category)}
          </p>

          <p class="meta-line">
            <strong>Customer site:</strong> ${escapeHtml(customerSite)}${costCenterHtml}<br />
            <strong>Date:</strong> ${escapeHtml(observationDate)}<br />
            ${locationHtml}
            <strong>Report generated:</strong> ${escapeHtml(today)}
          </p>

          <hr />

          <h2>People involved</h2>
          <p>${peopleHtml}</p>

          <h2>Description of the situation</h2>
          <p>${formatTextBlock(description)}</p>

          <h2>Prevention and improvements</h2>
          <p>${formatTextBlock(opinion)}</p>

          <h2>Measures taken & follow-up</h2>
          <p>
            ${
              measures
                ? formatTextBlock(measures)
                : "No measures have been recorded yet."
            }
            ${commentsHtml}
            ${rewardHtml}
          </p>

          ${insightsSection}
        `;

        reportContainer.classList.remove("hidden");
        enablePdfButtons(true);
        reportContainer.scrollIntoView({ behavior: "smooth" });
      });

      async function makePdf() {
        if (!window.jspdf || !window.jspdf.jsPDF) {
          alert(
            "The PDF library did not load. Please check your network connection."
          );
          return;
        }

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ unit: "mm", format: "a4" });

        doc.setFont("helvetica", "bold");
        doc.setFontSize(18);
        doc.text("Occupational Safety Observation", 15, 20);

        doc.setFont("helvetica", "normal");
        doc.setFontSize(11);

        const lines = reportPreview.innerText
          .split("\n")
          .map((l) => l.trim())
          .filter(Boolean);

        const maxWidth = 180;
        const lineHeight = 6;
        let y = 32;

        lines.forEach((line) => {
          const chunks = doc.splitTextToSize(line, maxWidth);

          chunks.forEach((chunk) => {
            if (y > 280) {
              doc.addPage();
              y = 20;
            }
            doc.text(chunk, 15, y);
            y += lineHeight;
          });

          y += 2;
        });

        const filename =
          "occupational-safety-observation-" +
          new Date().toISOString().slice(0, 10) +
          ".pdf";
        doc.save(filename);
      }

      [pdfBtn, topPdfBtn].forEach((btn) => {
        if (!btn) return;
        btn.addEventListener("click", function (e) {
          e.preventDefault();
          makePdf();
        });
      });

      // Start with PDF buttons disabled
      enablePdfButtons(false);
    })();
  </script>
</body>
</html>
