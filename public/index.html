<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>SISKON Safety Report Generator</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      :root {
        --bg: #0f172a;
        --panel: #020617;
        --panel-alt: #020617;
        --accent: #0ea5e9;
        --accent-soft: rgba(56, 189, 248, 0.15);
        --text: #e5e7eb;
        --muted: #9ca3af;
        --border: #1f2937;
        --danger: #ef4444;
        --success: #22c55e;
        --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.85);
        --radius-lg: 24px;
        --radius-md: 14px;
        --radius-pill: 999px;
        --input-bg: #020617;
        --input-border: #1f2937;
        --input-border-focus: #0ea5e9;
        --badge-bg: #020617;
        --badge-text: #e5e7eb;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
          "Segoe UI", sans-serif;
        background: radial-gradient(circle at top left, #0f172a, #020617 40%),
          radial-gradient(circle at bottom right, #111827, #020617 55%),
          linear-gradient(145deg, #020617, #020617);
        color: var(--text);
        display: flex;
        align-items: stretch;
        justify-content: center;
        padding: 24px;
      }

      .app-frame {
        width: 100%;
        max-width: 1120px;
        display: grid;
        grid-template-columns: minmax(0, 6fr) minmax(0, 5fr);
        gap: 20px;
        background: linear-gradient(145deg, #020617, #020617);
        border-radius: 32px;
        box-shadow: var(--shadow-soft);
        border: 1px solid rgba(148, 163, 184, 0.15);
        overflow: hidden;
      }

      @media (max-width: 900px) {
        body {
          padding: 16px;
        }
        .app-frame {
          grid-template-columns: minmax(0, 1fr);
          border-radius: 24px;
        }
      }

      .left-pane {
        padding: 24px 24px 20px 24px;
        border-right: 1px solid rgba(148, 163, 184, 0.12);
        background: radial-gradient(circle at top left, #020617, #020617 50%);
      }

      @media (max-width: 900px) {
        .left-pane {
          border-right: none;
          border-bottom: 1px solid rgba(148, 163, 184, 0.12);
        }
      }

      .right-pane {
        padding: 24px 24px 20px 24px;
        background: radial-gradient(circle at top right, #020617, #020617 55%);
      }

      .app-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 22px;
        gap: 12px;
      }

      .app-title-group {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .app-title {
        font-size: 1.15rem;
        font-weight: 600;
        letter-spacing: 0.03em;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .app-badge {
        padding: 3px 9px;
        border-radius: 999px;
        font-size: 0.7rem;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        border: 1px solid rgba(148, 163, 184, 0.4);
        color: #e5e7eb;
        background: radial-gradient(circle at top, #020617, #020617);
      }

      .app-subtitle {
        font-size: 0.8rem;
        color: var(--muted);
      }

      .section-label {
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.16em;
        color: var(--muted);
        margin: 10px 0 6px;
      }

      .input-card {
        background: radial-gradient(circle at top left, #020617, #020617 65%);
        border-radius: var(--radius-lg);
        border: 1px solid rgba(30, 64, 175, 0.6);
        padding: 14px 16px 14px;
        margin-bottom: 14px;
        position: relative;
        overflow: hidden;
      }

      .input-card-inner {
        position: relative;
        z-index: 1;
      }

      .form-row {
        display: grid;
        grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
        gap: 10px;
        margin-bottom: 10px;
      }

      @media (max-width: 600px) {
        .form-row {
          grid-template-columns: minmax(0, 1fr);
        }
      }

      .form-group {
        display: flex;
        flex-direction: column;
        gap: 4px;
        margin-bottom: 8px;
      }

      label {
        font-size: 0.78rem;
        color: #9ca3af;
      }

      input[type="text"],
      input[type="date"],
      input[type="number"],
      select,
      textarea {
        width: 100%;
        padding: 7px 9px;
        border-radius: 9px;
        border: 1px solid var(--input-border);
        background: var(--input-bg);
        color: var(--text);
        font-size: 0.8rem;
        outline: none;
        transition: border-color 0.14s ease, box-shadow 0.14s ease,
          background-color 0.14s ease;
      }

      input::placeholder,
      textarea::placeholder {
        color: #4b5563;
      }

      input:focus,
      select:focus,
      textarea:focus {
        border-color: var(--input-border-focus);
        box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.5);
        background-color: #020617;
      }

      textarea {
        resize: vertical;
        min-height: 60px;
      }

      select {
        appearance: none;
        background-image: linear-gradient(45deg, transparent 50%, #9ca3af 50%),
          linear-gradient(135deg, #9ca3af 50%, transparent 50%);
        background-position: calc(100% - 13px) calc(50% - 3px),
          calc(100% - 9px) calc(50% - 3px);
        background-size: 6px 6px, 6px 6px;
        background-repeat: no-repeat;
      }

      .checkbox-row {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 4px;
      }

      .checkbox-pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 5px 10px;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.9);
        border: 1px solid rgba(148, 163, 184, 0.6);
        font-size: 0.7rem;
        color: #e5e7eb;
      }

      .checkbox-pill input[type="checkbox"] {
        width: 12px;
        height: 12px;
        accent-color: #38bdf8;
      }

      .hint {
        font-size: 0.7rem;
        color: var(--muted);
      }

      .generate-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        margin-top: 8px;
      }

      .generate-left {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      .generate-meta {
        font-size: 0.7rem;
        color: #9ca3af;
      }

      .generate-meta strong {
        color: #e5e7eb;
      }

      .generate-button {
        padding: 8px 18px;
        border-radius: 999px;
        border: none;
        font-size: 0.8rem;
        font-weight: 600;
        letter-spacing: 0.06em;
        text-transform: uppercase;
        cursor: pointer;
        color: #0f172a;
        background: radial-gradient(circle at top left, #38bdf8, #0ea5e9);
        box-shadow: 0 12px 25px rgba(8, 47, 73, 0.7);
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      .generate-button:disabled {
        opacity: 0.6;
        cursor: default;
        box-shadow: none;
      }

      .generate-spinner {
        width: 14px;
        height: 14px;
        border-radius: 999px;
        border: 2px solid rgba(15, 23, 42, 0.1);
        border-top-color: #0f172a;
        animation: spin 0.8s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .error-banner {
        display: none;
        align-items: center;
        gap: 6px;
        padding: 6px 8px;
        border-radius: 9px;
        background: rgba(239, 68, 68, 0.11);
        border: 1px solid rgba(248, 113, 113, 0.5);
        color: #fecaca;
        font-size: 0.72rem;
        margin-bottom: 10px;
      }

      .error-dot {
        width: 8px;
        height: 8px;
        border-radius: 999px;
        background: var(--danger);
      }

      .output-card {
        background: radial-gradient(circle at top right, #020617, #020617 60%);
        border-radius: var(--radius-lg);
        border: 1px solid rgba(148, 163, 184, 0.4);
        padding: 14px 16px 12px;
        min-height: 200px;
        position: relative;
        overflow: hidden;
      }

      .output-inner {
        position: relative;
        z-index: 1;
        height: 100%;
        display: flex;
        flex-direction: column;
      }

      .output-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        margin-bottom: 10px;
      }

      .output-title {
        font-size: 0.8rem;
        font-weight: 500;
        letter-spacing: 0.1em;
        text-transform: uppercase;
        color: #9ca3af;
      }

      .output-meta-row {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-bottom: 8px;
      }

      .output-meta-pill {
        padding: 3px 8px;
        border-radius: 999px;
        font-size: 0.7rem;
        background: rgba(15, 23, 42, 0.95);
        border: 1px solid rgba(148, 163, 184, 0.5);
        color: #e5e7eb;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      .output-meta-pill span.dot {
        width: 7px;
        height: 7px;
        border-radius: 999px;
        background: #4ade80;
      }

      .output-body {
        flex: 1;
        min-height: 180px;
        padding: 10px 10px 8px;
        border-radius: 12px;
        background: rgba(15, 23, 42, 0.9);
        border: 1px solid rgba(31, 41, 55, 0.9);
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
        font-size: 0.78rem;
        line-height: 1.5;
        color: #e5e7eb;
        white-space: pre-wrap;
        overflow: auto;
      }

      .output-placeholder {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        text-align: center;
        color: #6b7280;
        gap: 6px;
      }

      .output-placeholder-icon {
        width: 32px;
        height: 32px;
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.4);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.1rem;
      }

      .output-placeholder-text {
        font-size: 0.78rem;
      }

      .small-kpi-hint {
        font-size: 0.7rem;
        color: var(--muted);
        margin-top: -2px;
        margin-bottom: 6px;
      }

      .footer-hint {
        font-size: 0.7rem;
        color: #6b7280;
        margin-top: 8px;
        text-align: right;
      }
    </style>
  </head>
  <body>
    <div class="app-frame">
      <div class="left-pane">
        <header class="app-header">
          <div class="app-title-group">
            <div class="app-title">
              SISKON Safety Reports
              <span class="app-badge">Internal tool</span>
            </div>
            <div class="app-subtitle">
              Generate structured summaries from occupational safety observations
            </div>
          </div>
        </header>

        <div id="errorBanner" class="error-banner">
          <span class="error-dot"></span>
          <span id="errorText">Something went wrong. Please try again.</span>
        </div>

        <div class="section-label">Data &amp; settings</div>
        <div class="input-card">
          <div class="input-card-inner">
            <div class="form-group">
              <label for="file_input">Upload observations file (.xlsx or .csv)</label>
              <input
                type="file"
                id="file_input"
                accept=".xlsx,.xls,.csv"
              />
              <div class="hint">
                Use the exported occupational safety observations file from your system.
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="language">Report language</label>
                <select id="language">
                  <option value="English">English</option>
                  <option value="Finnish">Finnish</option>
                </select>
              </div>
              <div class="form-group">
                <label for="time_range">Time window</label>
                <select id="time_range">
                  <option value="Last 7 days">Last 7 days</option>
                  <option value="Last 30 days" selected>Last 30 days</option>
                  <option value="This calendar year">This calendar year</option>
                  <option value="Custom period (describe in notes)">
                    Custom period (describe in notes)
                  </option>
                </select>
              </div>
            </div>

            <div class="form-group">
              <label for="site_focus">Customer site or group to focus on</label>
              <input
                type="text"
                id="site_focus"
                placeholder="Example: ‚ÄúAll Scandic hotels‚Äù or ‚ÄúGreenstar Hotel Jyv√§skyl√§ (KP 88)‚Äù or ‚ÄúAll KP 88 observations‚Äù"
              />
              <div class="hint">
                You can write one site, several sites, a KP cost center, or leave
                empty to use all observations.
              </div>
            </div>

            <div class="form-group">
              <label for="report_purpose">What kind of report do you need?</label>
              <select id="report_purpose">
                <option value="Management safety summary">
                  Management safety summary (high-level, with key themes and
                  actions)
                </option>
                <option value="Team safety meeting material">
                  Team safety meeting material (practical examples and talking
                  points)
                </option>
                <option value="Customer-facing summary">
                  Customer-facing summary (polished, focus on improvements and
                  follow-up)
                </option>
                <option value="Root cause and trend analysis">
                  Root cause and trend analysis (categories, patterns, repeated
                  risks)
                </option>
              </select>
            </div>

            <!-- KP free-text focus field -->
            <div class="form-group">
              <label for="kpi_focus">
                What KP should this report focus on?
              </label>
              <input
                type="text"
                id="kpi_focus"
                placeholder="Example: KP 88 slips and trips, or ‚Äúfocus especially on KP 820 near misses‚Äù"
              />
              <div class="small-kpi-hint">
                You can write any free text here (a single KP, several KPs, or a
                theme). This will be used as the main focus line for the report.
              </div>
            </div>

            <div class="form-group">
              <label for="extra_notes">
                Anything else the report should emphasize?
              </label>
              <textarea
                id="extra_notes"
                placeholder="Example: ‚ÄúHighlight positive safety behaviour examples and concrete corrective actions. Group by customer site and include practical tips for supervisors.‚Äù"
              ></textarea>
            </div>

            <div class="form-group">
              <label>Formatting options</label>
              <div class="checkbox-row">
                <label class="checkbox-pill">
                  <input type="checkbox" id="include_bullets" checked />
                  Bullet lists for key points
                </label>
                <label class="checkbox-pill">
                  <input type="checkbox" id="include_headings" checked />
                  Clear section headings
                </label>
                <label class="checkbox-pill">
                  <input type="checkbox" id="include_examples" checked />
                  Include concrete example cases
                </label>
              </div>
              <div class="hint">
                The tool will summarise and paraphrase; it will not copy source
                text directly or expose any personal data.
              </div>
            </div>

            <div class="generate-row">
              <div class="generate-left">
                <div class="generate-meta">
                  Source: <strong>Uploaded observations file</strong>
                </div>
                <div class="generate-meta">
                  Output: <strong>Clean, ready-to-send report text</strong>
                </div>
              </div>
              <button id="generateBtn" class="generate-button" type="button">
                <span
                  id="generateSpinner"
                  class="generate-spinner"
                  style="display: none"
                ></span>
                <span id="generateLabel">Generate report</span>
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="right-pane">
        <div class="section-label">Report preview</div>
        <div class="output-card">
          <div class="output-inner">
            <div class="output-header">
              <div class="output-title">
                Generated summary ‚Äì ready to copy into email, Word or PowerPoint
              </div>
            </div>

            <div class="output-meta-row">
              <div class="output-meta-pill">
                <span class="dot"></span>
                Language: <span id="metaLanguage">English</span>
              </div>
              <div class="output-meta-pill">
                Time window: <span id="metaTimeRange">Last 30 days</span>
              </div>
              <div class="output-meta-pill">
                Site focus:
                <span id="metaSiteFocus">All sites / KPs</span>
              </div>
            </div>

            <div id="output" class="output-body">
              <div class="output-placeholder">
                <div class="output-placeholder-icon">üßæ</div>
                <div class="output-placeholder-text">
                  Upload a file, fill in the fields on the left and click
                  ‚ÄúGenerate report‚Äù.<br />
                  The report will appear here as structured, ready-to-use text.
                </div>
              </div>
            </div>

            <div class="footer-hint">
              Only the uploaded data and your instructions are used to prepare
              the report text.
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const generateBtn = document.getElementById("generateBtn");
      const generateSpinner = document.getElementById("generateSpinner");
      const generateLabel = document.getElementById("generateLabel");
      const outputEl = document.getElementById("output");
      const errorBanner = document.getElementById("errorBanner");
      const errorText = document.getElementById("errorText");

      const metaLanguage = document.getElementById("metaLanguage");
      const metaTimeRange = document.getElementById("metaTimeRange");
      const metaSiteFocus = document.getElementById("metaSiteFocus");

      function setGenerating(isGenerating) {
        if (isGenerating) {
          generateBtn.disabled = true;
          generateSpinner.style.display = "inline-block";
          generateLabel.textContent = "Generating‚Ä¶";
        } else {
          generateBtn.disabled = false;
          generateSpinner.style.display = "none";
          generateLabel.textContent = "Generate report";
        }
      }

      function showError(message) {
        errorText.textContent = message;
        errorBanner.style.display = "flex";
      }

      function hideError() {
        errorBanner.style.display = "none";
      }

      function buildPrompt(fileName) {
        const selectedLanguage = document.getElementById("language").value;
        const timeRange = document.getElementById("time_range").value;
        const siteFocus = document.getElementById("site_focus").value.trim();
        const reportPurpose =
          document.getElementById("report_purpose").value;
        const extraNotes = document.getElementById("extra_notes").value.trim();
        const includeBullets =
          document.getElementById("include_bullets").checked;
        const includeHeadings =
          document.getElementById("include_headings").checked;
        const includeExamples =
          document.getElementById("include_examples").checked;

        const kpiFocusRaw =
          document.getElementById("kpi_focus").value.trim();
        const kpiFocus =
          kpiFocusRaw || "No specific KP focus provided by the user";

        const effectiveSiteFocus =
          siteFocus.length > 0 ? siteFocus : "All available sites and KPs";

        const formattingPrefs = [];
        if (includeHeadings) {
          formattingPrefs.push(
            "use clear section headings (###) for main parts of the report"
          );
        }
        if (includeBullets) {
          formattingPrefs.push(
            "use bullet lists for key points, themes and actions"
          );
        }
        if (includeExamples) {
          formattingPrefs.push(
            "include a few concrete observation examples, anonymised"
          );
        }

        return `
You are preparing an internal occupational safety report for Siskon Siivous.

Write the report in: ${selectedLanguage}.

Data source:
- Uploaded observations file: ${fileName}
- Columns include (among others): Created, Updated, Title, Owner, Person in charge, Customer site, Cost center (KP), Employee, Name of the informant, Location, Date, Description of the situation, Share your opinion (how the situation could have been avoided or how to ensure it does not happen again), Category of the observation, Measures taken, Comments from the occupational safety organisation, Rewarded (yes/no).

Context and scope:
- Time window to consider: ${timeRange}.
- Site / customer / KP focus requested by the user: ${effectiveSiteFocus}.
- Report type / purpose: ${reportPurpose}.
- User-provided report focus (KP-related or thematic): ${kpiFocus}.
- Additional notes from the user: ${
          extraNotes.length > 0 ? extraNotes : "None provided."
        }

Important constraints:
- Do not invent customers, people or specific events that are not present in the data.
- Do not copy any text directly from the source data. Always paraphrase and generalise.
- Treat all persons as anonymised employees or customers; do not use real names.
- Respect confidentiality and do not include any personally identifying information.

What you know about the data (schema level):
- Many observations from different customer sites (e.g. hotels, gyms, schools, offices, residential buildings).
- Categories can include: slips and falls, sharp objects, electrical risks, fire safety, broken equipment, poor lighting, threatening situations, positive safety behaviour, etc.
- Observations often include both the situation and suggested corrective actions or safety reminders.
- The ‚ÄúKP‚Äù field is a cost center / customer identifier, such as KP 88, KP 820, etc.

Your task:
1. Assume you have access to all observations that match the time window and site/KP focus.
2. From those, write a coherent safety report tailored to the requested purpose.
3. Focus especially on the KP-related focus text the user gave: "${kpiFocus}".
   - This might name one KP (e.g. "KP 88") or describe a theme ("KP 88 slips and trips", "KP 820 near misses").
   - Treat it as the central lens through which you select and group insights.

Suggested report structure:
- Short introduction: 2‚Äì3 sentences explaining what the report covers (sites/KPs, time window, purpose).
- Key themes and findings:
  - 2‚Äì4 main bullet points summarising the most important safety themes, repeating patterns or trends.
  - If relevant, highlight which KP(s) or customer sites are most visible in each theme.
- Concrete examples:
  - 2‚Äì4 brief anonymised examples that illustrate different types of observations (e.g. sharp object, near miss, equipment failure, positive safety behaviour).
  - Do not quote the original texts; describe them generally.
- Corrective and preventive actions:
  - 3‚Äì7 practical, actionable recommendations that supervisors and teams can implement.
  - Link them to the typical categories (e.g. slips and falls, electrical risks, threatening situations, etc.).
- Section for follow-up:
  - Short list of suggested follow-up items (e.g. training topics, checks, process improvements) that would be useful based on the observations.

Formatting preferences:
- ${
          formattingPrefs.length > 0
            ? formattingPrefs.join("; ")
            : "use normal paragraphs, but keep the structure clear and readable"
        }.
- Keep the whole report reasonably concise (roughly 0.5‚Äì1 A4 page in normal font size).
- Use neutral, professional language.

Now write only the full report text, without any additional explanation or meta-commentary.
        `.trim();
      }

      // Replace this with your real backend endpoint
      async function callBackend(prompt, fileName) {
        // Example structure ‚Äì adjust URL and body to match your existing function
        const res = await fetch("/.netlify/functions/generate-report", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ prompt, filename: fileName }),
        });
        if (!res.ok) {
          throw new Error("Backend error: " + res.status);
        }
        const data = await res.json();
        return data.text || "";
      }

      generateBtn.addEventListener("click", async () => {
        hideError();

        const fileInput = document.getElementById("file_input");
        const file = fileInput.files[0];

        if (!file) {
          showError("Please upload an observations file first.");
          return;
        }

        setGenerating(true);
        try {
          const prompt = buildPrompt(file.name);

          const selectedLanguage =
            document.getElementById("language").value;
          const timeRange = document.getElementById("time_range").value;
          const siteFocus =
            document.getElementById("site_focus").value.trim();

          metaLanguage.textContent = selectedLanguage;
          metaTimeRange.textContent = timeRange;
          metaSiteFocus.textContent =
            siteFocus.length > 0 ? siteFocus : "All sites / KPs";

          const reportText = await callBackend(prompt, file.name);

          outputEl.textContent = reportText;
        } catch (e) {
          console.error(e);
          showError(
            "Failed to generate report. Please check your connection and try again."
          );
        } finally {
          setGenerating(false);
        }
      });
    </script>
  </body>
</html>
