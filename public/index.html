<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Occupational Safety Analysis</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background:#f4f4f4; }
    .page {
      max-width: 900px; margin: 0 auto; background:white;
      padding: 32px 40px; border-radius: 10px; box-shadow:0 2px 8px rgba(0,0,0,0.08);
    }
    h1,h2,h3,h4 { margin: 0 0 8px 0; color:#222; }
    h1 { font-size: 26px; text-align:center; text-transform:uppercase; letter-spacing:1px; }
    h2 { font-size: 20px; margin-top:24px; border-bottom:1px solid #ddd; padding-bottom:4px; }
    h3 { font-size: 16px; margin-top:18px; }
    .meta { text-align:center; margin-bottom:20px; color:#555; }
    .summary-grid {
      display:grid; grid-template-columns: repeat(4, minmax(0,1fr));
      gap:12px; margin:16px 0;
    }
    .card {
      border:1px solid #ddd; border-radius:6px; padding:10px 12px; font-size:13px;
    }
    .card-title { font-weight:bold; font-size:12px; color:#555; text-transform:uppercase; }
    .card-value { font-size:16px; margin-top:4px; }
    table {
      width:100%; border-collapse:collapse; font-size:11px; margin-top:8px;
    }
    th, td {
      border:1px solid #ddd; padding:4px 6px; vertical-align:top;
    }
    th {
      background:#fafafa; text-align:left; font-weight:bold;
    }
    ul { margin:6px 0 10px 18px; padding:0; font-size:12px; }
    .kp-header {
      margin-top:24px; padding:10px 12px; background:#f6f7ff;
      border-left:4px solid #667eea;
    }
    .highlight { font-weight:bold; color:#c62828; }
    .tagline { font-size:12px; color:#777; margin-top:4px; }
    .download-btn {
      margin-top:16px; padding:8px 18px; border:none; border-radius:4px;
      background:#667eea; color:white; cursor:pointer; font-weight:600;
    }
    .controls { margin-bottom:18px; display:flex; gap:8px; flex-wrap:wrap; }
    .controls input, .controls textarea {
      padding:6px 8px; font-size:12px; border-radius:4px; border:1px solid #ccc;
    }
    .controls textarea { min-width:260px; min-height:40px; }
  </style>
</head>
<body>
  <div class="page">
    <h1>Occupational Safety Analysis</h1>
    <div class="meta" id="reportMeta">
      <!-- e.g. “KPs: 810, 815, 82, 820, 825, 86 – Year 2025” injected here -->
    </div>

    <div class="controls">
      <input id="kpFocus" type="text" placeholder="KP focus (e.g. 82, 820, sharp objects)" />
      <input id="periodStart" type="date" />
      <input id="periodEnd" type="date" />
      <textarea id="emphasis" placeholder="What should this report emphasize?"></textarea>
      <button id="generateBtn">Generate</button>
      <button id="pdfBtn">Make PDF</button>
      <input id="fileInput" type="file" accept=".xlsx,.xls,.csv" />
    </div>

    <div id="summarySection">
      <h2>Summary</h2>
      <div class="summary-grid" id="summaryCards"></div>
      <p id="summaryNarrative"></p>
    </div>

    <div id="kpSections"></div>

    <div id="criticalSection">
      <h2>Critical incidents overview</h2>
      <p id="criticalNarrative"></p>
    </div>

    <div id="recommendSection">
      <h2>Next-year safety priorities</h2>
      <p id="recommendIntro"></p>
      <ul id="recommendList"></ul>
    </div>
  </div>

  <script>
    let observations = [];

    document.getElementById('fileInput').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (ev) => {
        const wb = XLSX.read(ev.target.result, { type: 'binary' });
        const ws = wb.Sheets[wb.SheetNames[0]];
        const data = XLSX.utils.sheet_to_json(ws);
        observations = data.map(row => ({
          date: row.Date || row.date,
          kp: row.KP || row.kp,
          risk: row.Risk || row.risk,
          category: row.Category || row.category,
          location: row.Location || row.location,
          description: row.Description || row.description,
        }));
        alert(`Loaded ${observations.length} rows from Excel.`);
      };
      reader.readAsBinaryString(file);
    });

    document.getElementById('generateBtn').addEventListener('click', generateReport);
    document.getElementById('pdfBtn').addEventListener('click', makePDF);

    async function generateReport() {
      if (!observations.length) {
        alert('Upload Excel first.');
        return;
      }

      const kpFocus = document.getElementById('kpFocus').value.trim() || null;
      const start = document.getElementById('periodStart').value || null;
      const end = document.getElementById('periodEnd').value || null;
      const emphasis = document.getElementById('emphasis').value.trim() || null;

      const body = JSON.stringify({
        data: observations,
        userOptions: { kpFocus, start, end, emphasis }
      });

      const res = await fetch('/.netlify/functions/analyze-index', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body
      });

      const report = await res.json();
      // report is expected to already contain the structured numbers & text.

      fillOverview(report.overview);
      fillKPs(report.kps);
      fillCritical(report.critical);
      fillRecommendations(report.recommendations);
    }

    function fillOverview(o) {
      document.getElementById('reportMeta').textContent =
        `${o.kpLabel} – ${o.yearLabel}`;
      const cards = document.getElementById('summaryCards');
      cards.innerHTML = '';
      const items = [
        { title: 'Total observations', value: o.totalObservations },
        { title: 'High-risk cases', value: o.highRiskLabel },
        { title: 'Positive observations', value: o.positiveLabel },
        { title: 'Period', value: o.periodLabel }
      ];
      items.forEach(i => {
        const div = document.createElement('div');
        div.className = 'card';
        div.innerHTML = `<div class="card-title">${i.title}</div>
                         <div class="card-value">${i.value}</div>`;
        cards.appendChild(div);
      });
      document.getElementById('summaryNarrative').textContent = o.narrative;
    }

    function fillKPs(kps) {
      const container = document.getElementById('kpSections');
      container.innerHTML = '';
      kps.forEach(kp => {
        const section = document.createElement('div');
        section.innerHTML = `
          <div class="kp-header">
            <h2>${kp.title}</h2>
            <div class="tagline">
              Total: ${kp.total} | High‑risk: <span class="highlight">${kp.highRiskLabel}</span> |
              Period: ${kp.periodLabel}
            </div>
          </div>
          <h3>All cases with dates</h3>
          <table>
            <thead>
              <tr>
                <th>Date</th>
                <th>Category</th>
                <th>Location</th>
                <th>Issue</th>
              </tr>
            </thead>
            <tbody>
              ${kp.rows.map(r => `
                <tr>
                  <td>${r.date}</td>
                  <td>${r.category}</td>
                  <td>${r.location}</td>
                  <td>${r.issue}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
          <h3>Main themes</h3>
          <ul>
            ${kp.keyIssues.map(i => `<li>${i}</li>`).join('')}
          </ul>
        `;
        container.appendChild(section);
      });
    }

    function fillCritical(c) {
      document.getElementById('criticalNarrative').textContent = c.narrative;
    }

    function fillRecommendations(r) {
      document.getElementById('recommendIntro').textContent = r.intro;
      const list = document.getElementById('recommendList');
      list.innerHTML = '';
      r.items.forEach(item => {
        const li = document.createElement('li');
        li.innerHTML = `<strong>${item.title}.</strong> ${item.text}`;
        list.appendChild(li);
      });
    }

    function makePDF() {
      const element = document.querySelector('.page');
      const fileName = 'Occupational-Safety-Analysis.pdf';
      html2pdf().set({
        margin: 10,
        filename: fileName,
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
      }).from(element).save();
    }
  </script>
</body>
</html>
